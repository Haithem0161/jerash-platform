---
phase: 08-polish-seo
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - vite.config.ts
  - package.json
  - src/main.tsx
  - src/routes/index.tsx
  - src/lib/web-vitals.ts
  - src/components/home/HeroSlideshow.tsx
autonomous: false

must_haves:
  truths:
    - "Gallery and Careers pages load as separate chunks (code splitting)"
    - "Service worker caches static assets for offline/fast repeat visits"
    - "Web Vitals (LCP, CLS, INP) are measured and logged in production"
    - "Hero slideshow first two images are preloaded"
    - "Hero images use picture element with WebP source for modern browsers"
  artifacts:
    - path: "vite.config.ts"
      provides: "PWA plugin config"
      contains: "VitePWA"
    - path: "src/lib/web-vitals.ts"
      provides: "Web Vitals initialization"
      exports: ["reportWebVitals"]
    - path: "src/routes/index.tsx"
      provides: "Lazy-loaded routes"
      contains: "lazy"
  key_links:
    - from: "src/main.tsx"
      to: "src/lib/web-vitals.ts"
      via: "reportWebVitals call"
      pattern: "reportWebVitals"
    - from: "vite.config.ts"
      to: "vite-plugin-pwa"
      via: "VitePWA plugin"
      pattern: "VitePWA"
---

<objective>
Optimize performance with code splitting, service worker caching, Web Vitals monitoring, and hero image optimization.

Purpose: Achieve sub-3-second page loads on Fast 3G connections for Iraqi users with varying network quality.
Output: Lazy-loaded routes, PWA service worker, Web Vitals reporting, hero image preloading, WebP hero images.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-polish-seo/08-CONTEXT.md
@.planning/phases/08-polish-seo/08-RESEARCH.md
@vite.config.ts
@src/main.tsx
@src/routes/index.tsx
@src/components/home/HeroSlideshow.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure service worker</name>
  <files>
    package.json
    vite.config.ts
    src/lib/web-vitals.ts
    src/main.tsx
  </files>
  <action>
1. Install performance dependencies:
   ```bash
   pnpm add web-vitals vite-plugin-pwa
   ```

2. Update vite.config.ts to add VitePWA plugin:
   ```typescript
   import { VitePWA } from 'vite-plugin-pwa'

   export default defineConfig({
     plugins: [
       react({...}),
       tailwindcss(),
       VitePWA({
         registerType: 'autoUpdate',
         workbox: {
           globPatterns: ['**/*.{js,css,html,ico,png,jpg,jpeg,svg,webp,avif,woff2}'],
           cleanupOutdatedCaches: true,
           runtimeCaching: [
             {
               urlPattern: /^https:\/\/fonts\.googleapis\.com\/.*/i,
               handler: 'CacheFirst',
               options: {
                 cacheName: 'google-fonts-cache',
                 expiration: {
                   maxEntries: 10,
                   maxAgeSeconds: 60 * 60 * 24 * 365, // 1 year
                 },
               },
             },
             {
               urlPattern: /^https:\/\/fonts\.gstatic\.com\/.*/i,
               handler: 'CacheFirst',
               options: {
                 cacheName: 'gstatic-fonts-cache',
                 expiration: {
                   maxEntries: 10,
                   maxAgeSeconds: 60 * 60 * 24 * 365,
                 },
               },
             },
           ],
         },
         manifest: {
           name: 'Jerash For Oil Field Services',
           short_name: 'Jerash',
           description: 'Excellence in oil field solutions',
           theme_color: '#000000',
           icons: [
             {
               src: '/icon-192.png',
               sizes: '192x192',
               type: 'image/png',
             },
             {
               src: '/icon-512.png',
               sizes: '512x512',
               type: 'image/png',
             },
           ],
         },
       }),
     ],
     // ... rest of config
   })
   ```

3. Create src/lib/web-vitals.ts:
   ```typescript
   import { onCLS, onINP, onLCP } from 'web-vitals'

   type MetricHandler = (metric: { name: string; value: number; id: string }) => void

   /**
    * Initialize Web Vitals reporting.
    * Call ONCE in main.tsx - calling multiple times causes duplicate reports.
    */
   export function reportWebVitals(onReport?: MetricHandler) {
     // Only report in production to avoid dev noise
     if (import.meta.env.PROD) {
       const handler: MetricHandler = onReport ?? ((metric) => {
         // Default: log to console (replace with analytics endpoint in production)
         console.log(`[Web Vitals] ${metric.name}: ${metric.value}`)

         // Optional: send to analytics endpoint
         // navigator.sendBeacon('/api/vitals', JSON.stringify(metric))
       })

       onCLS(handler)
       onINP(handler)
       onLCP(handler)
     }
   }
   ```

4. Update src/main.tsx to initialize Web Vitals ONCE:
   ```typescript
   import { StrictMode } from 'react'
   import { createRoot } from 'react-dom/client'
   import './App.css'
   import App from './App'
   import { reportWebVitals } from '@/lib/web-vitals'

   createRoot(document.getElementById('root')!).render(
     <StrictMode>
       <App />
     </StrictMode>,
   )

   // Initialize Web Vitals - call once, never in components
   reportWebVitals()
   ```
  </action>
  <verify>
    `pnpm build` passes
    Build output includes service worker files (sw.js, workbox-*.js)
    Check dist/ folder for manifest.webmanifest
  </verify>
  <done>
    vite-plugin-pwa configured with static asset caching
    web-vitals library installed and initialized in main.tsx
    Service worker generated on build
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement code splitting and hero preloading</name>
  <files>
    src/routes/index.tsx
    src/components/home/HeroSlideshow.tsx
  </files>
  <action>
1. Update src/routes/index.tsx to lazy load heavy pages:
   ```typescript
   import { createBrowserRouter } from 'react-router'
   import { lazy, Suspense } from 'react'
   import { RootLayout } from '@/components/layout/RootLayout'
   import { LoadingOverlay } from '@/components/common/LoadingOverlay'

   // Eager load critical pages (small, frequently visited)
   import { HomePage } from './pages/Home'
   import { ServicesPage } from './pages/Services'
   import { HSEPage } from './pages/HSE'
   import { NotFoundPage } from './pages/NotFound'

   // Lazy load heavier pages (forms, file upload, large galleries)
   // Pages have default exports, so direct lazy() works
   const GalleryPage = lazy(() => import('./pages/Gallery'))
   const ContactPage = lazy(() => import('./pages/Contact'))
   const CareersPage = lazy(() => import('./pages/Careers'))
   const PartnersPage = lazy(() => import('./pages/Partners'))
   const JointVenturesPage = lazy(() => import('./pages/JointVentures'))

   // Suspense wrapper for lazy components
   function LazyPage({ children }: { children: React.ReactNode }) {
     return (
       <Suspense fallback={<div className="min-h-screen flex items-center justify-center"><LoadingOverlay /></div>}>
         {children}
       </Suspense>
     )
   }

   export const router = createBrowserRouter([
     {
       path: '/',
       element: <RootLayout />,
       children: [
         { index: true, element: <HomePage /> },
         { path: 'services', element: <ServicesPage /> },
         { path: 'hse', element: <HSEPage /> },
         { path: 'gallery', element: <LazyPage><GalleryPage /></LazyPage> },
         { path: 'contact', element: <LazyPage><ContactPage /></LazyPage> },
         { path: 'careers', element: <LazyPage><CareersPage /></LazyPage> },
         { path: 'partners', element: <LazyPage><PartnersPage /></LazyPage> },
         { path: 'joint-ventures', element: <LazyPage><JointVenturesPage /></LazyPage> },
         { path: '*', element: <NotFoundPage /> },
       ],
     },
   ])
   ```

2. Update HeroSlideshow.tsx to preload first two images:
   - Find where heroSlides array is defined
   - Add useEffect to preload first two slide images on mount:
   ```typescript
   import { useEffect } from 'react'

   // Inside HeroSlideshow component, after slides array:
   useEffect(() => {
     // Preload first two hero images for smooth initial transition
     HERO_IMAGES.slice(0, 2).forEach((src) => {
       const img = new Image()
       img.src = src
     })
   }, [])
   ```

   Also add fetchpriority="high" to the currently visible hero image's img tag if not already present.
  </action>
  <verify>
    `pnpm build` - check that dist/assets/ contains multiple JS chunks (not just one large bundle)
    `pnpm dev` - navigate to Gallery page, observe network tab shows separate chunk loading
    DevTools Network tab: first two hero images start loading immediately on homepage
  </verify>
  <done>
    5 pages lazy-loaded: Gallery, Contact, Careers, Partners, JointVentures
    3 pages eager: Home, Services, HSE (core pages)
    Hero first 2 images preloaded on mount
  </done>
</task>

<task type="checkpoint:human" gate="blocking">
  <name>Task 3: Create WebP versions of hero images</name>
  <what-built>
    Code splitting and PWA service worker are configured. Hero image preloading is implemented.
    The HeroSlideshow component will be updated to use &lt;picture&gt; element with WebP source,
    but WebP image files need to be created manually.
  </what-built>
  <action>
1. Update HeroSlideshow.tsx to use &lt;picture&gt; element with WebP + fallback.
   The component currently uses CSS background-image. Convert to proper img/picture:

   ```tsx
   // Replace background-image approach with picture element:
   <picture>
     <source
       srcSet={HERO_IMAGES[currentSlide].replace(/\.(jpg|jpeg|png)$/i, '.webp')}
       type="image/webp"
     />
     <img
       src={HERO_IMAGES[currentSlide]}
       alt={t('home.hero.imageAlt', 'Jerash oil field operations')}
       className="absolute inset-0 w-full h-full object-cover animate-ken-burns"
       fetchPriority={currentSlide === 0 ? 'high' : 'auto'}
     />
   </picture>
   ```

2. Update the preload to include WebP variants:
   ```typescript
   useEffect(() => {
     HERO_IMAGES.slice(0, 2).forEach((src) => {
       // Preload WebP version
       const webpImg = new Image()
       webpImg.src = src.replace(/\.(jpg|jpeg|png)$/i, '.webp')
       // Also preload original as fallback
       const img = new Image()
       img.src = src
     })
   }, [])
   ```
  </action>
  <how-to-verify>
    WebP images need to be created manually before this plan is fully complete:

    1. Use an online converter (e.g., squoosh.app) or local tools to convert:
       - /public/WhatsApp Image 2026-01-09 at 4.37.40 PM.jpeg -> .webp
       - /public/WhatsApp Image 2026-01-09 at 4.37.47 PM.jpeg -> .webp
       - /public/WhatsApp Image 2026-01-09 at 4.37.32 PM.jpeg -> .webp
       - /public/WhatsApp Image 2026-01-09 at 4.37.48 PM.jpeg -> .webp

    2. Place WebP files in public/ with matching names (just different extension)

    3. Test in browser:
       - Open DevTools Network tab
       - Filter by "Img"
       - Hero images should load as .webp in Chrome/Firefox/Edge

    If WebP conversion is deferred, the site will still work (falls back to JPEG).
    This can be done pre-deployment.
  </how-to-verify>
  <resume-signal>Type "webp done" when WebP files are created, or "skip webp" to continue without (fallback to JPEG works)</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds: `pnpm build`
2. Check dist/ folder:
   - Multiple .js chunks in dist/assets/ (code splitting working)
   - sw.js and workbox-*.js present (service worker generated)
   - manifest.webmanifest present (PWA manifest)
3. Run `pnpm preview` and:
   - Open DevTools > Application > Service Workers - shows registered worker
   - Navigate between pages - chunks load on demand
   - Refresh page - assets served from cache (check Network > Size column)
4. Hero images:
   - WebP files exist or documented for manual creation
   - &lt;picture&gt; element used in HeroSlideshow
</verification>

<success_criteria>
- Service worker registers and caches static assets
- Gallery, Contact, Careers, Partners, JointVentures are separate chunks
- Web Vitals initialized once in main.tsx (production only)
- Hero images 1-2 preloaded on homepage mount
- Hero images use WebP with fallback via &lt;picture&gt; element (or documented for manual conversion)
- Build produces multiple JS chunks (not monolithic bundle)
</success_criteria>

<output>
After completion, create `.planning/phases/08-polish-seo/08-02-SUMMARY.md`
</output>
